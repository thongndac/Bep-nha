<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bếp Nhà – Menu & Gợi ý</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <!-- React 18 UMD + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX in browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // === Basic UI atoms ===
    const Card = ({ children, className = "" }) => (
      <div className={"bg-white rounded-2xl shadow p-4 border border-gray-100 " + className}>{children}</div>
    );
    const Tag = ({ children }) => (
      <span className="px-2 py-0.5 rounded-full text-xs border mr-1 mb-1 inline-block">{children}</span>
    );

    // === LocalStorage helpers ===
    const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
    const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

    // === Pantry seasoning ignore list ===
    const IGNORED = new Set(["muối","đường","nước mắm","nước tương","tiêu","dầu ăn","hành tím","tỏi","hạt nêm","bột ngọt","giấm","bột năng","dầu hào"]);

    function App() {
      // --- Data states ---
      const [menu, setMenu] = useState(load("menu_v1", [])); // [{name, ingredients:[] , notes?}]
      const [fridge, setFridge] = useState(load("fridge_v2", [])); // [{name, qty?, unit?, exp?, location?}]
      const [lastBatch, setLastBatch] = useState(load("last_batch_v1", [])); // [names]

      useEffect(() => save("menu_v1", menu), [menu]);
      useEffect(() => save("fridge_v2", fridge), [fridge]);
      useEffect(() => save("last_batch_v1", lastBatch), [lastBatch]);

      // --- UI states ---
      const [showMenu, setShowMenu] = useState(false);
      const [showImport, setShowImport] = useState(false);
      const [showAll, setShowAll] = useState(false);

      // --- MENU editor states ---
      const blankRecipe = () => ({ name: "", ingCount: 3, ingredients: ["","",""], notes: "" });
      const [editingIdx, setEditingIdx] = useState(null); // null: nothing, -1: add new, >=0 edit
      const [formRecipe, setFormRecipe] = useState(blankRecipe());

      // Make ingredients array follow ingCount
      const syncIngCount = (n) => {
        const count = Math.max(0, Math.min(30, Number(n) || 0));
        setFormRecipe(r => {
          let arr = Array.isArray(r.ingredients) ? [...r.ingredients] : [];
          if (arr.length < count) arr = arr.concat(Array(count - arr.length).fill(""));
          if (arr.length > count) arr = arr.slice(0, count);
          return { ...r, ingCount: count, ingredients: arr };
        });
      };

      const openAddRecipe = () => { setEditingIdx(-1); setFormRecipe(blankRecipe()); };
      const openEditRecipe = (idx) => {
        const r = menu[idx];
        setEditingIdx(idx);
        setFormRecipe({
          name: r.name || "",
          ingCount: Math.max(0, (r.ingredients || []).length),
          ingredients: (r.ingredients || []).slice(),
          notes: r.notes || ""
        });
      };
      const saveRecipe = () => {
        const payload = {
          name: (formRecipe.name || "").trim(),
          ingredients: (formRecipe.ingredients || []).map(s => (s || "").trim()).filter(Boolean),
          notes: (formRecipe.notes || "").trim()
        };
        if (!payload.name) return alert("Nhập tên món.");
        if (payload.ingredients.length === 0) return alert("Nhập ít nhất 1 nguyên liệu.");
        if (editingIdx === -1) setMenu(prev => [...prev, payload]);
        else setMenu(prev => prev.map((r,i) => i===editingIdx ? payload : r));
        setEditingIdx(null);
        setFormRecipe(blankRecipe());
      };
      const deleteRecipe = (idx) => {
        if (!confirm("Xoá món này khỏi Menu?")) return;
        setMenu(prev => prev.filter((_,i) => i!==idx));
        if (editingIdx === idx) { setEditingIdx(null); setFormRecipe(blankRecipe()); }
      };

      // --- IMPORT modal states ---
      const [importCount, setImportCount] = useState(3);
      const [importRows, setImportRows] = useState([{name:"",qty:"",unit:"",exp:"",location:"Tủ lạnh"},{name:"",qty:"",unit:"",exp:"",location:"Tủ lạnh"},{name:"",qty:"",unit:"",exp:"",location:"Tủ lạnh"}]);

      const syncImportCount = (n) => {
        const count = Math.max(1, Math.min(30, Number(n) || 1));
        setImportCount(count);
        setImportRows(rows => {
          let arr = [...rows];
          if (arr.length < count) {
            const add = Array(count - arr.length).fill(null).map(() => ({name:"",qty:"",unit:"",exp:"",location:"Tủ lạnh"}));
            arr = arr.concat(add);
          } else if (arr.length > count) {
            arr = arr.slice(0, count);
          }
          return arr;
        });
      };

      const commitImport = () => {
        const cleaned = importRows.map(r => ({...r, name: (r.name||"").trim()})).filter(r => !!r.name);
        if (cleaned.length === 0) return alert("Chưa có dòng nào hợp lệ.");
        // Merge into fridge: append (đơn giản); nếu trùng tên thì vẫn thêm dòng mới
        setFridge(prev => [...prev, ...cleaned]);
        setLastBatch(cleaned.map(r => r.name));
        setShowImport(false);
      };

      // --- Match & Suggestion ---
      const lastSet = useMemo(() => new Set((lastBatch||[]).map(s => s.trim().toLowerCase())), [lastBatch]);
      const fridgeSet = useMemo(() => new Set(fridge.map(i => (i.name || "").trim().toLowerCase())), [fridge]);

      const scored = useMemo(() => {
        const all = (menu || []).map(r => {
          const req = (r.ingredients || []).map(s => s.trim().toLowerCase()).filter(x => x && !IGNORED.has(x));
          const haveNew = req.every(x => lastSet.has(x));
          const haveAll = req.every(x => lastSet.has(x) || fridgeSet.has(x));
          const missing = req.filter(x => !(lastSet.has(x) || fridgeSet.has(x)));
          const priority = (haveNew ? 2 : 0) + (haveAll ? 1 : 0); // 3=full match with new, 1=match with fridge
          return { recipe: r, haveNew, haveAll, missing, priority };
        });
        // Candidates: full matches first (priority 3), then matches via fridge (priority 1)
        const full = all.filter(x => x.priority === 3);
        const viaFridge = all.filter(x => x.priority === 1);
        return { full, viaFridge, all };
      }, [menu, lastSet, fridgeSet]);

      const [pickIdx, setPickIdx] = useState(0);
      useEffect(() => { setPickIdx(0); }, [JSON.stringify(scored.full.map(x=>x.recipe.name)), JSON.stringify(scored.viaFridge.map(x=>x.recipe.name))]);

      const currentPool = scored.full.length > 0 ? scored.full : scored.viaFridge;
      const suggestion = currentPool.length > 0 ? currentPool[pickIdx % currentPool.length] : null;
      const shufflePick = () => {
        if (currentPool.length <= 1) return;
        let next = Math.floor(Math.random() * currentPool.length);
        if (next === (pickIdx % currentPool.length)) next = (next + 1) % currentPool.length;
        setPickIdx(next);
      };

      return (
        <div className="min-h-screen">
          <div className="max-w-5xl mx-auto p-4 md:p-6">
            <header className="mb-4 md:mb-6">
              <div className="flex items-start justify-between gap-3">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold">Bếp Nhà – Menu & Gợi ý</h1>
                  <p className="text-sm text-slate-600 mt-1">Tạo thư viện món thường nấu (Menu) • Nhập tủ lạnh • Gợi ý dựa trên đợt nhập gần nhất.</p>
                </div>
                <div className="flex items-center gap-2">
                  <button className="px-3 py-2 rounded-xl border text-sm" onClick={() => setShowMenu(true)}>Menu (món thường nấu)</button>
                  <button className="px-3 py-2 rounded-xl border text-sm" onClick={() => setShowImport(true)}>Nhập tủ lạnh</button>
                </div>
              </div>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
              <div className="space-y-4">
                <Card>
                  <div className="flex items-center justify-between">
                    <h2 className="font-semibold">Gợi ý dựa trên đợt nhập gần nhất</h2>
                    <div className="text-xs text-slate-500">{lastBatch.length ? `Đợt nhập: ${lastBatch.join(', ')}` : "Chưa có đợt nhập nào"}</div>
                  </div>

                  {suggestion ? (
                    <div className="mt-3">
                      <div className="flex items-center justify-between">
                        <div className="text-lg font-medium">{suggestion.recipe.name}</div>
                        <div className="flex gap-2">
                          <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={shufflePick}>Đổi gợi ý</button>
                        </div>
                      </div>
                      <div className="mt-2">
                        <div className="text-sm font-medium">Nguyên liệu cần:</div>
                        <ul className="list-disc pl-5 text-sm mt-1">
                          {(suggestion.recipe.ingredients||[]).map((ing, i) => (
                            <li key={i}>
                              {ing}
                              {IGNORED.has(ing.trim().toLowerCase()) ? <span className="text-xs text-slate-400"> (gia vị)</span> : null}
                            </li>
                          ))}
                        </ul>
                        {suggestion.missing?.length > 0 && (
                          <div className="text-xs text-amber-600 mt-2">Thiếu: {suggestion.missing.join(', ')}</div>
                        )}
                      </div>
                      <div className="mt-3">
                        <button className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm shadow hover:opacity-90">Nấu món này</button>
                      </div>
                    </div>
                  ) : (
                    <div className="mt-3 text-sm text-slate-500">
                      Chưa có món phù hợp. Hãy mở <span className="font-medium">Menu</span> để thêm món, rồi nhập tủ lạnh.
                    </div>
                  )}

                  {(scored.full.length + scored.viaFridge.length) > 0 && (
                    <div className="mt-3">
                      <button className="text-sm underline" onClick={() => setShowAll(s => !s)}>
                        {showAll ? "Ẩn danh sách phù hợp" : `Xem tất cả phù hợp (${(scored.full.length || 0) + (scored.viaFridge.length || 0)})`}
                      </button>
                    </div>
                  )}
                </Card>

                {showAll && (
                  <Card>
                    <h3 className="font-semibold">Danh sách phù hợp</h3>
                    {scored.full.length > 0 && (
                      <div className="mt-2">
                        <div className="text-sm text-emerald-700 font-medium">Khớp hoàn toàn từ đợt nhập</div>
                        <ul className="mt-1 space-y-1">
                          {scored.full.map((x, i) => (
                            <li key={i} className="flex items-center justify-between border rounded-lg p-2">
                              <div>
                                <div className="font-medium">{x.recipe.name}</div>
                                <div className="text-xs text-slate-500">{x.recipe.ingredients.length} nguyên liệu</div>
                              </div>
                              <button className="text-sm underline" onClick={() => setPickIdx(i)}>Chọn</button>
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                    {scored.viaFridge.length > 0 && (
                      <div className="mt-3">
                        <div className="text-sm text-slate-700 font-medium">Khớp bằng đồ sẵn trong tủ</div>
                        <ul className="mt-1 space-y-1">
                          {scored.viaFridge.map((x, i) => (
                            <li key={i} className="flex items-center justify-between border rounded-lg p-2">
                              <div>
                                <div className="font-medium">{x.recipe.name}</div>
                                <div className="text-xs text-slate-500">{x.recipe.ingredients.length} nguyên liệu</div>
                              </div>
                              <button className="text-sm underline" onClick={() => setPickIdx(i)}>Chọn</button>
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </Card>
                )}
              </div>

              <div className="space-y-4">
                <Card>
                  <div className="flex items-center justify-between">
                    <h2 className="font-semibold">Tủ lạnh hiện có</h2>
                    <div className="flex items-center gap-2">
                      {fridge.length > 0 && (
                        <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={() => setFridge([])}>Xoá hết</button>
                      )}
                      <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={() => setShowImport(true)}>+ Nhập tủ lạnh</button>
                    </div>
                  </div>
                  {fridge.length === 0 ? (
                    <p className="text-sm text-slate-500 mt-2">Chưa có gì. Bấm “Nhập tủ lạnh”.</p>
                  ) : (
                    <ul className="space-y-2 max-h-96 overflow-auto pr-1 mt-2">
                      {fridge.map((it, idx) => (
                        <li key={idx} className="flex items-center justify-between bg-slate-50 rounded-xl border p-2 gap-2">
                          <div>
                            <div className="font-medium">{it.name}</div>
                            <div className="text-xs text-slate-500">{it.qty || '-'} {it.unit || ''} • {it.location || 'Tủ lạnh'}{it.exp ? ` • HSD: ${it.exp}` : ''}</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <button className="text-red-600 text-sm" onClick={() => setFridge(fridge.filter((_,i)=>i!==idx))}>Xoá</button>
                          </div>
                        </li>
                      ))}
                    </ul>
                  )}
                </Card>
              </div>
            </div>

            {/* --- MENU MODAL --- */}
            {showMenu && (
              <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4">
                <div className="bg-white w-full max-w-4xl max-h-[85vh] overflow-auto rounded-2xl shadow p-4">
                  <div className="flex items-center justify-between">
                    <h3 className="font-semibold">Menu (món thường nấu)</h3>
                    <button className="text-sm" onClick={() => setShowMenu(false)}>Đóng</button>
                  </div>

                  <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div className="md:col-span-2">
                      <div className="flex items-center justify-between mb-2">
                        <div className="text-sm text-slate-500">{menu.length} món</div>
                        <button className="px-3 py-2 rounded-xl border text-sm" onClick={openAddRecipe}>+ Thêm món</button>
                      </div>
                      {menu.length === 0 ? (
                        <p className="text-sm text-slate-500">Chưa có món nào. Bấm “+ Thêm món”.</p>
                      ) : (
                        <ul className="divide-y">
                          {menu.map((r, idx) => (
                            <li key={idx} className="py-2">
                              <div className="flex items-start justify-between gap-2">
                                <div>
                                  <div className="font-medium">{r.name}</div>
                                  <div className="text-xs text-slate-500">{(r.ingredients||[]).length} nguyên liệu</div>
                                  <div className="mt-1 flex flex-wrap">
                                    {(r.ingredients||[]).map((x,i) => <Tag key={i}>{x}</Tag>)}
                                  </div>
                                </div>
                                <div className="flex items-center gap-2">
                                  <button className="text-blue-600 text-sm" onClick={() => openEditRecipe(idx)}>Sửa</button>
                                  <button className="text-red-600 text-sm" onClick={() => deleteRecipe(idx)}>Xoá</button>
                                </div>
                              </div>
                            </li>
                          ))}
                        </ul>
                      )}
                    </div>

                    <div className="md:col-span-1">
                      {editingIdx === null ? (
                        <div className="text-sm text-slate-500">Chọn “+ Thêm món” hoặc “Sửa” để chỉnh công thức. Bạn có thể đặt trước số lượng nguyên liệu, hệ thống sẽ nhảy ra đúng số ô nhập.</div>
                      ) : (
                        <div className="border rounded-xl p-3">
                          <div className="font-semibold mb-2">{editingIdx === -1 ? 'Thêm món mới' : 'Sửa món'}</div>
                          <div className="grid grid-cols-2 gap-2">
                            <input className="col-span-2 w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" placeholder="Tên món" value={formRecipe.name} onChange={e => setFormRecipe(r => ({ ...r, name: e.target.value }))} />
                            <div className="col-span-2">
                              <label className="text-xs font-medium">Số nguyên liệu</label>
                              <input className="w-full mt-1 px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" type="number" min="0" max="30" value={formRecipe.ingCount} onChange={e => syncIngCount(e.target.value)} />
                            </div>

                            <div className="col-span-2">
                              <div className="text-xs font-medium mb-1">Nguyên liệu</div>
                              <div className="space-y-2 max-h-60 overflow-auto pr-1">
                                {(formRecipe.ingredients || []).map((val, i) => (
                                  <input key={i} className="w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" placeholder={"Nguyên liệu #" + (i+1)} value={val} onChange={e => setFormRecipe(r => {
                                    const arr = [...r.ingredients]; arr[i] = e.target.value; return { ...r, ingredients: arr };
                                  })} />
                                ))}
                              </div>
                            </div>

                            <textarea className="col-span-2 w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" rows="2" placeholder="Ghi chú (tuỳ chọn)" value={formRecipe.notes} onChange={e => setFormRecipe(r => ({ ...r, notes: e.target.value }))}></textarea>

                            <div className="col-span-2 flex justify-end gap-2 mt-2">
                              <button className="px-3 py-2 rounded-xl border text-sm" onClick={() => { setEditingIdx(null); setFormRecipe(blankRecipe()); }}>Hủy</button>
                              <button className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm" onClick={saveRecipe}>Lưu</button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* --- IMPORT MODAL --- */}
            {showImport && (
              <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4">
                <div className="bg-white w-full max-w-3xl max-h-[85vh] overflow-auto rounded-2xl shadow p-4">
                  <div className="flex items-center justify-between">
                    <h3 className="font-semibold">Nhập tủ lạnh (đợt mới)</h3>
                    <button className="text-sm" onClick={() => setShowImport(false)}>Đóng</button>
                  </div>

                  <div className="mt-3">
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-2 items-end">
                      <div className="col-span-2">
                        <label className="text-xs font-medium">Số dòng</label>
                        <input className="w-full mt-1 px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" type="number" min="1" max="30" value={importCount} onChange={e => syncImportCount(e.target.value)} />
                      </div>
                      <div className="col-span-4 text-xs text-slate-500">Điền tên nguyên liệu (vd: thịt gà, cá lóc...). Có thể kèm số lượng/đơn vị/HSD nếu muốn.</div>
                    </div>

                    <div className="mt-3 space-y-2 max-h-96 overflow-auto pr-1">
                      {importRows.map((row, idx) => (
                        <div key={idx} className="grid grid-cols-2 md:grid-cols-6 gap-2">
                          <input className="col-span-2 md:col-span-2 w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" placeholder={"Tên hàng #" + (idx+1)} value={row.name} onChange={e => setImportRows(rs => { const a=[...rs]; a[idx] = {...a[idx], name: e.target.value}; return a; })} />
                          <input className="w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" placeholder="SL" value={row.qty} onChange={e => setImportRows(rs => { const a=[...rs]; a[idx] = {...a[idx], qty: e.target.value}; return a; })} />
                          <select className="w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" value={row.unit} onChange={e => setImportRows(rs => { const a=[...rs]; a[idx] = {...a[idx], unit: e.target.value}; return a; })}>
                            <option value="">(đv)</option>
                            {['g','kg','ml','l','cái','con','quả','miếng','bó','cây'].map(u => <option key={u}>{u}</option>)}
                          </select>
                          <input className="w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" type="date" value={row.exp} onChange={e => setImportRows(rs => { const a=[...rs]; a[idx] = {...a[idx], exp: e.target.value}; return a; })} />
                          <select className="w-full px-3 py-2 bg-white rounded-xl border border-slate-200 text-sm" value={row.location} onChange={e => setImportRows(rs => { const a=[...rs]; a[idx] = {...a[idx], location: e.target.value}; return a; })}>
                            {['Tủ lạnh','Ngăn đá','Tủ khô'].map(l => <option key={l}>{l}</option>)}
                          </select>
                        </div>
                      ))}
                    </div>

                    <div className="mt-3 flex justify-end gap-2">
                      <button className="px-3 py-2 rounded-xl border text-sm" onClick={() => setImportRows(importRows.map(r => ({...r, name:"", qty:"", unit:"", exp:""})))}>Xoá nội dung</button>
                      <button className="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm" onClick={commitImport}>Thêm vào tủ</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <footer className="text-center text-xs text-slate-500 mt-8">MVP mới • Lưu dữ liệu tại trình duyệt (LocalStorage)</footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
